# develop manual开发手册

本文主要罗列出开发中得一些代码规范、错误、或者坑、随笔等等。

# 接口

### 1. 开发需要主要接口幂等性要求,特别是在特殊严格场景、比如支付场景不能重复支付。

### 2. 状态修改场景

比如实名认证场景功能,用户对应有三种状态 1:未审核 2:审核通过 3:
审核拒绝。后台管理员对用户进行实名审核,现实中管理员可能不只有一个可能有多个,OK假如此刻有两个管理员对同一用户进行权限审核,两个管理员看到得是同一用户数据并且都在同一个页面,此时A用户对用户进行审核通过,前端提示审核成功,此时另一个用户B也在同一个页面,由于一些事情没有立即审核,并且没有刷新页面,此时用户B回过头点击审核拒绝,此时前端提示审核成功，过了一段时间用户反馈我得身份认证怎么还没有通过,最后管理人员一堆扯皮拉上测试或者开发一起定位问题,最后发现是因为B用户审核时看到得数据是未审核之前得旧值,造成修改数据覆盖。
解决方案:

1. 此问题得方式是采用状态机判断、修改之前进行数据查询逻辑判断,此种方式适用于并发不高得场景。
2. 采用乐观锁思想。以旧状态值作为修改条件进行修改,或者以旧状态值作为修改条件进行修改,修改成功row
   affect返回1则代表成功返回0则代表没有查询到数据或者,修改得值和原来得旧值一样。
3. 如果数据库中表结构已经确定,没有能作为乐观锁得场景,或者状态场景,还可以使用分布式锁+逻辑判断得方式。

# 区块链

### 1.evm系列的合约地址大小写问题

在ethereum中，合约地址的大小写不敏感，但是一些工具和库可能会要求地址的大小写与实际一致,存储大小写需要根据实际情况考虑。例如:
`0xc98F67966c2263EC4cbB5437dF2C3E58f0C8bfab`
和 `0xc98f67966c2263ec4cbb5437df2c3e58f0c8bfab`视为同一个地址。
因此在实际使用场景中会存在地址大小写不匹配的问题，在开发过程中接口参数处理,或者入库处理需要统一处理一下。比如对地址ToLower()
或ToUpper()。

那么如果不转换直接写入到mysql库中,sql查询对大小写敏感么？答是视情况而定，如果mysql得数据库字符集是utf8mb4_general_ci,则不区分大小写,如果是其他得比如utf8_bin、utf8mb4_bin等则区分大小写。

**场景：**
需求根据用户evm地址缓存用户今日订单数量。由于redis是对大小写敏感的，比如缓存的key是`0xc98F67966c2263EC4cbB5437dF2C3E58f0C8bfab`
,但是在查询的时候使用得地址是`0xc98f67966c2263ec4cbb5437df2c3e58f0c8bfab`
,这就造成了数据未找到，因此在使用得时候对key进行统一转换处理,比如ToLower(address)。
