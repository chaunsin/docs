# Photoshop IRB

> - 来源: chatgpt生成
> - 时间: 2025-10-13
> - 说明：以下内容来自ai生成，部分内容拼凑而来，有错误请指正

Photoshop IRB 是也是一种用于存储图像数据的文件格式。通常只适用于jpg文件中得APP13段中。
，其他文件格式比如png、webp等如果想存储Photoshop公司规则的信息则需要准换成XMP或其他格式进行存储。

另外IRB也可以嵌入其他资源，比如[EXIF、IPTC、XMP](https://www.adobe.com/devnet-apps/photoshop/fileformatashtml/#50577409_38034)信息等。

---

## 🧩 一、JPEG 文件的总体层级结构

在说IRB之前先认识JPEG文件的总体层级结构。

JPEG 是一种 **分段结构的文件格式**，每个段由一个“标记（Marker）”开头，用来描述不同类型的数据。很多我们常见的元数据（EXIF、IPTC、XMP、ICC、IRB、Photoshop
Info）都不是随意放进文件里的，而是嵌入在这些**特定标记段**中。

JPEG 文件是由若干个 **Segment（段）** 组成的，基本结构如下：

```
+--------------------------------------------+
| SOI (Start of Image)                       |  ← 文件开始标记 (0xFFD8)
+--------------------------------------------+
| APP0 (JFIF or JFXX)                        |  ← 文件标识信息
+--------------------------------------------+
| APP1 (EXIF / XMP)                          |  ← 元数据段，可含 EXIF、XMP
+--------------------------------------------+
| APP2 (ICC Profile / FlashPix)              |  ← ICC 色彩配置文件
+--------------------------------------------+
| APP3 - APP13 (其他扩展数据)                 |  ← 可能包含 IPTC、Photoshop IRB
+--------------------------------------------+
| DQT (Define Quantization Table)            |  ← 量化表
+--------------------------------------------+
| SOF (Start of Frame)                       |  ← 图像帧开始（图像尺寸、采样信息）
+--------------------------------------------+
| DHT (Define Huffman Table)                 |  ← Huffman 编码表
+--------------------------------------------+
| SOS (Start of Scan)                        |  ← 压缩图像数据开始
+--------------------------------------------+
| 图像压缩数据 (Entropy-coded data)           |
+--------------------------------------------+
| EOI (End of Image)                         |  ← 文件结束标记 (0xFFD9)
+--------------------------------------------+
```

下面是一张逻辑结构层级图（文字版）：

```
JPEG File
├── SOI
├── APP0 (JFIF)
├── APP1
│   ├── EXIF (TIFF-based)
│   └── XMP (XML-based)
├── APP2
│   └── ICC Profile (.icc / .icm)
├── APP13
│   └── Photoshop IRB ("8BIM" blocks)
│       ├── IPTC-NAA (IIM format)
│       ├── Thumbnail
│       ├── ResolutionInfo
│       └── Photoshop Info
├── Image Data (SOF, DQT, DHT, SOS)
└── EOI
```

---

## 🧬 二、各元数据的嵌入关系与区别

### 1. **EXIF**

* **位置**：位于 `APP1` 段。
* **格式结构**：TIFF 格式的子集，包含 IFD（Image File Directory）。
* **内容**：拍摄设备信息、日期、GPS、曝光参数等。

```
APP1 (0xFFE1)
 └── "Exif\0\0"
     └── TIFF header
         └── IFD0 / IFD1 / ExifIFD / GPSIFD ...
```

---

### 2. **XMP**

* **位置**：通常也在 `APP1` 段（紧跟在 EXIF 后面）。
* **格式结构**：XML 文本。
* **内容**：Adobe 的扩展元数据，如标题、描述、标签、版权、作者等。

```
APP1 (0xFFE1)
 └── "http://ns.adobe.com/xap/1.0/"
     └── XML 格式的 <x:xmpmeta> 数据
```

---

### 3. **ICC Profile / ICM**

* **位置**：`APP2` 段。
* **格式结构**：ICC 标准二进制格式（Profile Header + Tag Table + Tag Data）。
* **作用**：描述色彩空间信息（sRGB、AdobeRGB、CMYK...）。
* **说明**：`.icc` 和 `.icm` 文件是相同格式，只是扩展名不同（Mac/Win 命名差异）。

```
APP2 (0xFFE2)
 └── "ICC_PROFILE\0"
     └── ICC profile data
```

---

### 4. **IPTC / IPTC-NAA / IPTC-IIM**

* **位置**：嵌入在 Photoshop IRB（`APP13` 段）中。
* **格式结构**：IIM（Information Interchange Model）

  ```
  0x1C | Record Number | Dataset Number | Size | Data
  ```
* **内容**：新闻摄影相关信息（标题、作者、说明、版权、关键字等）。
* **关系**：

    * “IPTC-NAA” 是早期规范（新闻联盟标准）
    * “IPTC-IIM” 是后续正式标准
    * Photoshop 将其打包进 IRB 的 Resource ID = 0x0404 区块中

---

## 🧩 三、Photoshop IRB（Image Resource Block）

上面交代完成正是开始说明Photoshop IRB。

### 1.位置

以jpg图片来说处于`APP13` 段。

### 2.用途

- 存放 IPTC、Photoshop 特定信息（图层、路径、预览缩略图、分辨率等）
- 其中 **Resource ID = 0x0404** 是 IPTC-NAA 数据块

### 3.基本结构

以下是单个IRB数据块的基本单元结构：

```
  Signature(4) | ResourceID(2) | Name(Pascal) | Size(4) | Data(size) | pad
```

精确字节结构描述:

```
8BIM 块 (IRB)
 ├── Signature (4 bytes): "8BIM" 或 "8B64"
 ├── Resource ID (2 bytes): 类型标识，例如 0x0404 = IPTC
 ├── Name (Pascal String)
 │    ├── Length byte (1)
 │    ├── Name bytes (可空)
 │    └── padding 至偶数
 ├── Size (4 bytes): Data 长度
 ├── Data (Size bytes): 实际内容
 └── Padding (0x00, 使 Data 区对齐为偶数)
```

> 注意点：Name 的长度字节 + name 本身 要使得后续的 Size 字段在偶地址对齐（因此可能有 1 字节填充）。Data 的末尾也要做偶字节对齐。

常见的Resource ID 对照表:

| Resource ID | 名称              | 含义                  | 典型数据格式              |
|-------------|-----------------|---------------------|---------------------|
| `0x03ED`    | Resolution Info | 分辨率信息               | 固定结构                |
| `0x0404`    | IPTC-NAA        | IPTC IIM 二进制流       | 二进制 Tag/Length/Data |
| `0x0409`    | Thumbnail       | 缩略图                 | JPEG 二进制            |
| `0x0419`    | XMP             | XMP 数据              | XML 文本              |
| `0x0422`    | ICC Profile     | 颜色配置文件              | ICC 数据流             |
| `0x040C`    | Photoshop Info  | Photoshop 特有信息      | 二进制                 |
| 其他          | 自定义             | Photoshop 内部使用或插件信息 | 任意数据                |

可参考官方文档： https://www.adobe.com/devnet-apps/photoshop/fileformatashtml/#50577409_69883

### 4.整体布局

简单格式描述：

```
APP13 marker (0xFFED) + length
"Photoshop 3.0" 0x00     // header string
IRB #1
IRB #2
IRB #3
...
```

详细描述：

```
JPEG 文件
├── 其他APP段省略...
└── APP13 段 (Marker: 0xFFED)
    ├── APP13 长度字段 (2 bytes)
    ├── 标识字符串: "Photoshop 3.0" + 0x00
    └── 一系列 Photoshop IRB 块 (Image Resource Blocks)
         ├── IRB #1
         │    ├── Signature: "8BIM" (4 bytes)
         │    ├── Resource ID: 0x03ED
         │    ├── Name (Pascal string)
         │    ├── Size (4 bytes, big-endian)
         │    ├── Data (Size bytes)
         │    │    └── 内容: ResolutionInfo （分辨率信息）
         │    └── Padding (0x00, 使结构对齐为偶数)
         │
         ├── IRB #2
         │    ├── Signature: "8BIM"
         │    ├── Resource ID: 0x0404
         │    ├── Name (Pascal string, 常为空)
         │    ├── Size (4 bytes)
         │    ├── Data (Size bytes)
         │    │    └── 内容: IPTC-NAA 数据块
         │    │         ├── 开始标识: 0x1C 02 xx ...
         │    │         ├── 各种 Dataset: Caption, Keywords, Author, ...
         │    │         └── 全部采用 IPTC IIM 二进制结构 (Tag/Length/Data)
         │    └── Padding (0x00)
         │
         ├── IRB #3
         │    ├── Signature: "8BIM"
         │    ├── Resource ID: 0x0419
         │    ├── Name (Pascal string)
         │    ├── Size (4 bytes)
         │    ├── Data (Size bytes)
         │    │    └── 内容: XMP 元数据 (完整 XML 文本)
         │    └── Padding (0x00)
         │
         ├── IRB #4
         │    ├── Signature: "8BIM"
         │    ├── Resource ID: 0x0409
         │    ├── Name (Pascal string)
         │    ├── Size (4 bytes)
         │    ├── Data (Size bytes)
         │    │    └── 内容: 缩略图 (通常是 JPEG 编码的小图)
         │    └── Padding (0x00)
         │
         ├── IRB #5
         │    ├── Signature: "8BIM"
         │    ├── Resource ID: 0x0422
         │    ├── Name (Pascal string)
         │    ├── Size (4 bytes)
         │    ├── Data (Size bytes)
         │    │    └── 内容: ICC Profile / Photoshop Info / 自定义数据
         │    └── Padding (0x00)
         │
         └── ... 其他 IRB (8BIM) 块
```

截短的十六进制示例（伪示例，便于理解平级结构）

```text
... FF ED 00 7A                ; APP13 marker + length
50 68 6F 74 6F 73 68 6F 70 20 33 2E 30 00   ; "Photoshop 3.0\0" header

// --- IRB #1 (IPTC-NAA) ---
38 42 49 4D                    ; '8BIM' signature
04 04                          ; ResourceID = 0x0404 (IPTC-NAA)
05                             ; Name length = 5
69 70 74 63 00                 ; "iptc" + pad (pascal string padded to even)
00 00 00 1A                    ; Size = 26 bytes (data length)
1C 02 05 00 0F ...             ; Data (IPTC IIM datasets start with 0x1C)
... (if size odd -> pad 00)

// --- IRB #2 (Photoshop Info) ---
38 42 49 4D                    ; '8BIM'
04 0C                          ; ResourceID = 0x040C (Photoshop Info)
00                             ; Name length = 0 (empty name)
00 00 00 12                    ; Size = 18 bytes
xx xx xx ...                   ; Photoshop Info data (key/value pairs)
... pad if needed

// ... more IRBs follow ...
```

## 四、代码

golang解析库，虽不全面但可参考
- https://github.com/dsoprea/go-photoshop-info-format

## 五、扩展

以下代码可以帮助理解JPEG图片的存储结构。拷贝运行此.jsx代码，可以进行交互。

```jsx
import React, {useState} from 'react';
import {ChevronRight, ChevronDown, FileImage, Layers} from 'lucide-react';

const JPEGStructure = () => {
    const [expandedSections, setExpandedSections] = useState({
        main: true,
        app0: false,
        app1: false,
        app13: false,
        app14: false,
        app2: false
    });

    const toggleSection = (section) => {
        setExpandedSections(prev => ({
            ...prev,
            [section]: !prev[section]
        }));
    };

    const segments = [
        {
            id: 'soi',
            marker: 'SOI (0xFFD8)',
            name: '文件起始标记',
            color: 'bg-blue-100 border-blue-300',
            desc: 'Start of Image - JPEG文件的第一个标记'
        },
        {
            id: 'app0',
            marker: 'APP0 (0xFFE0)',
            name: 'JFIF段',
            color: 'bg-green-100 border-green-300',
            expandable: true,
            desc: 'JFIF应用标记 - 包含图像基本信息',
            children: [
                '标识符: "JFIF\\0"',
                '版本号',
                '密度单位',
                'X/Y密度',
                '缩略图信息'
            ]
        },
        {
            id: 'app1',
            marker: 'APP1 (0xFFE1)',
            name: 'EXIF/XMP段',
            color: 'bg-yellow-100 border-yellow-300',
            expandable: true,
            desc: '可能包含多个APP1段',
            children: [
                {
                    title: 'EXIF数据块',
                    items: [
                        '标识符: "Exif\\0\\0"',
                        'TIFF头部 (字节序)',
                        'IFD0 (主图像信息)',
                        '  - 相机制造商、型号',
                        '  - 拍摄时间',
                        '  - 图像尺寸',
                        'EXIF IFD (扩展信息)',
                        '  - 曝光时间、光圈',
                        '  - ISO、焦距',
                        '  - 白平衡等',
                        'GPS IFD (GPS信息)',
                        'IFD1 (缩略图信息)'
                    ]
                },
                {
                    title: 'XMP数据块',
                    items: [
                        '标识符: "http://ns.adobe.com/xap/1.0/\\0"',
                        'XML格式的元数据',
                        '  - Dublin Core (dc:)',
                        '  - EXIF扩展 (exif:)',
                        '  - Photoshop (photoshop:)',
                        '  - IPTC Core (Iptc4xmpCore:)',
                        '  - 版权信息',
                        '  - 关键词、描述'
                    ]
                }
            ]
        },
        {
            id: 'app13',
            marker: 'APP13 (0xFFED)',
            name: 'Photoshop IRB段',
            color: 'bg-purple-100 border-purple-300',
            expandable: true,
            desc: 'Image Resource Block - Photoshop资源块',
            children: [
                {
                    title: '标识符: "Photoshop 3.0\\0"',
                    items: [
                        '图像资源块结构:',
                        '  - 资源类型 (4字节)',
                        '  - 资源ID (2字节)',
                        '  - 资源名称',
                        '  - 资源数据',
                        '',
                        '常见资源块:',
                        '  - 0x0404: IPTC-NAA记录',
                        '  - 0x040F: ICC Profile',
                        '  - 0x0419: 透明度索引',
                        '  - 0x041A: 全局光照角度',
                        '  - 0x0421: 版本信息',
                        '  - 0x0422: EXIF信息',
                        '  - 图层信息',
                        '  - 路径信息',
                        '  - 色彩配置'
                    ]
                },
                {
                    title: 'IPTC数据 (嵌入在IRB中)',
                    items: [
                        '位于资源ID 0x0404',
                        'IPTC IIM格式:',
                        '  - 记录号:字段号:值',
                        '  - 2:05 - 标题',
                        '  - 2:120 - 说明',
                        '  - 2:25 - 关键词',
                        '  - 2:80 - 作者',
                        '  - 2:116 - 版权',
                        '  - 2:90 - 城市',
                        '  - 2:101 - 国家'
                    ]
                }
            ]
        },
        {
            id: 'app2',
            marker: 'APP2 (0xFFE2)',
            name: 'ICC Profile段',
            color: 'bg-pink-100 border-pink-300',
            expandable: true,
            desc: 'ICC色彩配置文件',
            children: [
                '标识符: "ICC_PROFILE\\0"',
                '序列号 (分段传输时)',
                '总段数',
                'ICC配置文件数据:',
                '  - 配置文件头部',
                '  - 色彩空间类型',
                '  - 白点',
                '  - 色域映射表',
                '  - 转换矩阵'
            ]
        },
        {
            id: 'app14',
            marker: 'APP14 (0xFFEE)',
            name: 'Adobe段',
            color: 'bg-indigo-100 border-indigo-300',
            expandable: true,
            desc: 'Adobe DCT格式信息',
            children: [
                '标识符: "Adobe"',
                'DCT版本',
                '标志位',
                '颜色转换信息',
                'YCbCr/RGB转换标识'
            ]
        },
        {
            id: 'dqt',
            marker: 'DQT (0xFFDB)',
            name: '量化表',
            color: 'bg-orange-100 border-orange-300',
            desc: 'Define Quantization Table - 定义量化表'
        },
        {
            id: 'sof',
            marker: 'SOF0 (0xFFC0)',
            name: '帧起始',
            color: 'bg-red-100 border-red-300',
            desc: 'Start of Frame - 图像帧信息(宽高、颜色分量)'
        },
        {
            id: 'dht',
            marker: 'DHT (0xFFC4)',
            name: 'Huffman表',
            color: 'bg-teal-100 border-teal-300',
            desc: 'Define Huffman Table - 定义Huffman编码表'
        },
        {
            id: 'sos',
            marker: 'SOS (0xFFDA)',
            name: '扫描起始',
            color: 'bg-cyan-100 border-cyan-300',
            desc: 'Start of Scan - 图像数据开始'
        },
        {
            id: 'imagedata',
            marker: '压缩图像数据',
            name: '实际图像数据',
            color: 'bg-gray-200 border-gray-400',
            desc: '经过DCT变换、量化和Huffman编码的图像数据'
        },
        {
            id: 'eoi',
            marker: 'EOI (0xFFD9)',
            name: '文件结束标记',
            color: 'bg-blue-100 border-blue-300',
            desc: 'End of Image - JPEG文件的最后标记'
        }
    ];

    return (
        <div className="w-full max-w-4xl mx-auto p-6 bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div className="flex items-center gap-3 mb-4">
                    <FileImage className="w-8 h-8 text-blue-600"/>
                    <h1 className="text-3xl font-bold text-gray-800">JPEG图片数据存储结构</h1>
                </div>

                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                    <h2 className="font-semibold text-blue-900 mb-2">结构概览</h2>
                    <p className="text-sm text-blue-800">
                        JPEG文件由一系列的<strong>段(Segment)</strong>组成，每个段以<strong>标记(Marker)</strong>开始。
                        元数据(EXIF、XMP、IPTC、ICC等)存储在APPn段中。
                    </p>
                </div>

                <div className="space-y-3">
                    {segments.map((segment, index) => (
                        <div key={segment.id} className="relative">
                            {index > 0 && (
                                <div className="absolute left-8 -top-3 w-0.5 h-3 bg-gray-300"></div>
                            )}

                            <div className={`border-2 rounded-lg ${segment.color} overflow-hidden transition-all`}>
                                <div
                                    className={`p-4 ${segment.expandable ? 'cursor-pointer hover:bg-opacity-70' : ''}`}
                                    onClick={() => segment.expandable && toggleSection(segment.id)}
                                >
                                    <div className="flex items-start justify-between">
                                        <div className="flex items-start gap-3 flex-1">
                                            {segment.expandable && (
                                                <div className="mt-1">
                                                    {expandedSections[segment.id] ?
                                                        <ChevronDown className="w-5 h-5"/> :
                                                        <ChevronRight className="w-5 h-5"/>
                                                    }
                                                </div>
                                            )}
                                            <div className="flex-1">
                                                <div className="flex items-center gap-3 mb-1">
                                                    <code
                                                        className="bg-white px-2 py-1 rounded text-sm font-mono font-semibold">
                                                        {segment.marker}
                                                    </code>
                                                    <span className="font-bold text-gray-800">{segment.name}</span>
                                                </div>
                                                <p className="text-sm text-gray-600">{segment.desc}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {segment.expandable && expandedSections[segment.id] && segment.children && (
                                    <div className="border-t-2 border-gray-300 bg-white bg-opacity-50 p-4">
                                        <div className="space-y-4">
                                            {segment.children.map((child, idx) => (
                                                <div key={idx}>
                                                    {typeof child === 'string' ? (
                                                        <div
                                                            className="text-sm font-mono text-gray-700 pl-4">{child}</div>
                                                    ) : (
                                                        <div className="bg-white rounded p-3 border border-gray-200">
                                                            <div
                                                                className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                                                <Layers className="w-4 h-4"/>
                                                                {child.title}
                                                            </div>
                                                            <div className="space-y-1">
                                                                {child.items.map((item, itemIdx) => (
                                                                    <div
                                                                        key={itemIdx}
                                                                        className={`text-sm font-mono ${
                                                                            item.startsWith('  -') ? 'pl-8 text-gray-600' :
                                                                                item.startsWith('  ') ? 'pl-4 text-gray-700' :
                                                                                    'text-gray-800'
                                                                        }`}
                                                                    >
                                                                        {item}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                </div>

                <div className="mt-8 space-y-4">
                    <div
                        className="bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-500 p-4 rounded">
                        <h3 className="font-bold text-green-900 mb-2">📊 层级关系说明</h3>
                        <ul className="text-sm text-green-800 space-y-1">
                            <li>• <strong>IPTC</strong>: 嵌入在Photoshop IRB段(APP13)的资源块中，使用IIM格式</li>
                            <li>• <strong>IRB</strong>: Image Resource Block，Photoshop的资源容器(APP13)</li>
                            <li>• <strong>XMP</strong>: 独立的APP1段，使用XML格式存储</li>
                            <li>• <strong>EXIF</strong>: 另一个APP1段，使用TIFF结构存储</li>
                            <li>• <strong>ICC/ICM</strong>: 通常在APP2段，或嵌入在IRB中</li>
                        </ul>
                    </div>

                    <div
                        className="bg-gradient-to-r from-purple-50 to-purple-100 border-l-4 border-purple-500 p-4 rounded">
                        <h3 className="font-bold text-purple-900 mb-2">🔍 重要特点</h3>
                        <ul className="text-sm text-purple-800 space-y-1">
                            <li>• APP段可以重复出现(如多个APP1段分别存储EXIF和XMP)</li>
                            <li>• ICC Profile如果太大，会分成多个APP2段传输</li>
                            <li>• IPTC有新旧两种格式: IIM(嵌入IRB)和IPTC Core(在XMP中)</li>
                            <li>• Photoshop保存的JPEG包含最完整的元数据</li>
                            <li>• 元数据段都在实际图像数据之前</li>
                        </ul>
                    </div>

                    <div
                        className="bg-gradient-to-r from-amber-50 to-amber-100 border-l-4 border-amber-500 p-4 rounded">
                        <h3 className="font-bold text-amber-900 mb-2">⚡ 读取顺序</h3>
                        <p className="text-sm text-amber-800">
                            解析JPEG时，按顺序读取标记(Marker)，识别0xFF开头的字节，
                            然后根据标记类型读取对应长度的数据。APPn段的数据长度在标记后的2字节中指定。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default JPEGStructure;
```

## 参考

- https://www.adobe.com/devnet-apps/photoshop/fileformatashtml/#50577409_69883 官方文档`Image Resources Section`部分